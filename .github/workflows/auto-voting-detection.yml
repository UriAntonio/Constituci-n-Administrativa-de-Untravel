name: ğŸ—³ï¸ DetecciÃ³n AutomÃ¡tica de VotaciÃ³n

on:
  issue_comment:
    types: [created]

jobs:
  detect-voting:
    name: ğŸ” Detectar Votos y Generar Acta
    runs-on: ubuntu-latest
    if: |
      contains(github.event.comment.body, 'voto oficial') ||
      contains(github.event.comment.body, 'âœ…') ||
      contains(github.event.comment.body, 'âŒ') ||
      contains(github.event.comment.body, 'ğŸŸ¡') ||
      contains(github.event.comment.body, 'apruebo') ||
      contains(github.event.comment.body, 'rechazo') ||
      contains(github.event.comment.body, 'abstenciÃ³n')
      
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: Obtener versiÃ³n dinÃ¡mica
        id: get-version
        run: |
          if [ -f ".version" ]; then
            VERSION=$(cat .version)
          elif [ -f "CHANGELOG.md" ]; then
            VERSION=$(grep -m 1 "^## \[" CHANGELOG.md | sed 's/## \[\([^]]*\)\].*/\1/')
          else
            VERSION="3.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ—³ï¸ Procesar voto detectado
        id: process-vote
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.issue.number;
            const version = "${{ steps.get-version.outputs.version }}";
            const commentAuthor = context.payload.comment.user.login;
            const commentBody = context.payload.comment.body;
            
            console.log(`ğŸ—³ï¸ Voto detectado de @${commentAuthor} en issue #${issueNumber}`);
            
            // Verificar si es una propuesta legislativa
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            const labels = issue.labels.map(l => l.name);
            const isLegislative = labels.some(label => 
              ['legislativo', 'respaldo-legislativo', 'urgente', 'reforma-constitucional'].includes(label)
            );
            
            if (!isLegislative) {
              console.log('â­ï¸ No es una propuesta legislativa, saltando...');
              return { skipProcessing: true };
            }
            
            console.log('âœ… Es una propuesta legislativa, procesando voto...');
            
            // Obtener todos los comentarios para contar votos
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            
            // Contar votos
            const votes = { favor: 0, contra: 0, abstenciones: 0 };
            let lastVoteComment = null;
            
            for (const comment of comments) {
              const body = comment.body.toLowerCase();
              if (body.includes('voto oficial') || 
                  body.includes('apruebo') || 
                  body.includes('rechazo') || 
                  body.includes('abstenciÃ³n')) {
                    
                if (body.includes('âœ…') || body.includes('apruebo') || body.includes('a favor')) {
                  votes.favor++;
                } else if (body.includes('âŒ') || body.includes('rechazo') || body.includes('en contra')) {
                  votes.contra++;
                } else if (body.includes('ğŸŸ¡') || body.includes('abstenciÃ³n')) {
                  votes.abstenciones++;
                }
                lastVoteComment = comment;
              }
            }
            
            const totalVotos = votes.favor + votes.contra + votes.abstenciones;
            console.log(`ğŸ“Š Votos actuales: ${votes.favor} favor, ${votes.contra} contra, ${votes.abstenciones} abstenciones (${totalVotos} total)`);
            
            // Confirmar recepciÃ³n del voto
            const voteType = commentBody.toLowerCase().includes('âœ…') || commentBody.toLowerCase().includes('apruebo') ? 'âœ… A FAVOR' :
                           commentBody.toLowerCase().includes('âŒ') || commentBody.toLowerCase().includes('rechazo') ? 'âŒ EN CONTRA' :
                           commentBody.toLowerCase().includes('ğŸŸ¡') || commentBody.toLowerCase().includes('abstenciÃ³n') ? 'ğŸŸ¡ ABSTENCIÃ“N' : 
                           'â“ FORMATO NO RECONOCIDO';
            
            const voteConfirmation = `## ğŸ—³ï¸ Voto Registrado AutomÃ¡ticamente

            **Legislador:** @${commentAuthor}  
            **Voto:** ${voteType}  
            **Hora:** ${new Date().toLocaleString('es-ES')}  
            **Sistema:** GitHub Actions v${version}

            ### ğŸ“Š Estado Actual de la VotaciÃ³n

            - âœ… **A favor:** ${votes.favor} votos
            - âŒ **En contra:** ${votes.contra} votos  
            - ğŸŸ¡ **Abstenciones:** ${votes.abstenciones} votos
            - ğŸ“Š **Total:** ${totalVotos} votos

            ${totalVotos >= 3 ? 'âœ… **QuÃ³rum alcanzado** (mÃ­nimo 3 legisladores)' : 'â³ **Esperando quÃ³rum** (faltan ' + (3 - totalVotos) + ' votos)'}

            ${totalVotos >= 5 ? `

            ### ğŸ›ï¸ GeneraciÃ³n AutomÃ¡tica de Acta

            Al alcanzar **5 votos** se activarÃ¡ automÃ¡ticamente el **generador de actas oficial** que:
            - ğŸ“‹ CrearÃ¡ el acta oficial como nuevo Issue
            - ğŸ“Š CalcularÃ¡ estadÃ­sticas finales
            - âš–ï¸ DeterminarÃ¡ el resultado segÃºn mayorÃ­as requeridas
            - ğŸ” GenerarÃ¡ certificaciÃ³n criptogrÃ¡fica
            - ğŸ“¤ PublicarÃ¡ notificaciÃ³n del resultado

            **ğŸš€ Sin scripts .sh - Completamente automatizado con GitHub Actions**` : ''}

            ---
            *Voto procesado automÃ¡ticamente - Sistema sin dependencias externas*
            `;
            
            await github.rest.issues.createComment({
              issue_number: issueNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: voteConfirmation
            });
            
            // Si hay 5 o mÃ¡s votos, activar generador de acta automÃ¡ticamente
            if (totalVotos >= 5) {
              console.log('ğŸ‰ Activando generador de actas automÃ¡tico...');
              
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'legislative-tools-replacement.yml',
                ref: 'main',
                inputs: {
                  action: 'generate-acta',
                  issue_number: issueNumber.toString(),
                  additional_params: 'auto-generated-after-voting'
                }
              });
              
              await github.rest.issues.createComment({
                issue_number: issueNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ‰ GeneraciÃ³n AutomÃ¡tica de Acta Activada

            ğŸ—³ï¸ **Se han registrado ${totalVotos} votos** - Â¡Se ha alcanzado el umbral para generar automÃ¡ticamente el acta oficial!

            âš¡ **Proceso activado:**
            - ğŸ“‹ Generando acta oficial completa
            - ğŸ“Š Calculando estadÃ­sticas finales  
            - âš–ï¸ Determinando resultado segÃºn mayorÃ­as
            - ğŸ” Aplicando certificaciÃ³n criptogrÃ¡fica

            â±ï¸ **Tiempo estimado:** 1-2 minutos  
            ğŸ“Š **Seguir progreso:** [Actions Tab](../../actions)

            ğŸš€ **Sistema GitHub Actions v${version}** - Reemplaza completamente generate-acta.sh

            ---
            *ActivaciÃ³n automÃ¡tica del generador de actas - Sin intervenciÃ³n manual requerida*`
              });
            }
            
            return { 
              totalVotos: totalVotos, 
              voteType: voteType,
              skipProcessing: false 
            };

      - name: ğŸ“Š Resumen de detecciÃ³n
        if: steps.process-vote.outputs.skipProcessing != 'true'
        run: |
          echo "ğŸ—³ï¸ DetecciÃ³n de votaciÃ³n completada"
          echo "ğŸ“Š Total votos procesados: ${{ fromJson(steps.process-vote.outputs.result).totalVotos }}"
          echo "ğŸ”„ Tipo de voto: ${{ fromJson(steps.process-vote.outputs.result).voteType }}"
          echo "âœ… ConfirmaciÃ³n automÃ¡tica enviada"