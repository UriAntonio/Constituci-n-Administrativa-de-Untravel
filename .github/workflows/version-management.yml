name: ðŸ“Š GestiÃ³n AutomÃ¡tica de Versiones

on:
  push:
    branches: [ main ]
    paths: 
      - 'CONSTITUTION.md'
      - 'CHANGELOG.md'
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Tipo de versiÃ³n'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor
        - patch
      create_release:
        description: 'Crear release en GitHub'
        required: false
        default: true
        type: boolean

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  detect-version-change:
    name: ðŸ” Detectar Cambio de VersiÃ³n
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.version.outputs.current }}
      previous-version: ${{ steps.version.outputs.previous }}
      version-changed: ${{ steps.version.outputs.changed }}
      change-type: ${{ steps.version.outputs.type }}
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Para comparar con commit anterior
          
      - name: Obtener versiÃ³n actual y anterior
        id: version
        run: |
          # FunciÃ³n para extraer versiÃ³n del CHANGELOG
          extract_version() {
            local file="$1"
            if [ -f "$file" ]; then
              grep -m 1 "^## \[" "$file" | sed 's/## \[\([^]]*\)\].*/\1/' | head -1
            else
              echo "1.0.0"
            fi
          }
          
          # Obtener versiÃ³n actual
          CURRENT_VERSION=$(extract_version "CHANGELOG.md")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # Obtener versiÃ³n anterior del commit previo
          git checkout HEAD~1 -- CHANGELOG.md 2>/dev/null || echo "No previous version"
          PREVIOUS_VERSION=$(extract_version "CHANGELOG.md")
          git checkout HEAD -- CHANGELOG.md
          
          echo "previous=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT
          
          # Verificar si cambiÃ³ la versiÃ³n
          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Cambio de versiÃ³n detectado: $PREVIOUS_VERSION â†’ $CURRENT_VERSION"
            
            # Determinar tipo de cambio
            IFS='.' read -r curr_major curr_minor curr_patch <<< "$CURRENT_VERSION"
            IFS='.' read -r prev_major prev_minor prev_patch <<< "$PREVIOUS_VERSION"
            
            if [ "$curr_major" != "$prev_major" ]; then
              echo "type=major" >> $GITHUB_OUTPUT
            elif [ "$curr_minor" != "$prev_minor" ]; then
              echo "type=minor" >> $GITHUB_OUTPUT
            else
              echo "type=patch" >> $GITHUB_OUTPUT
            fi
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "type=none" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸ“‹ VersiÃ³n actual: $CURRENT_VERSION"
          echo "ðŸ“‹ VersiÃ³n anterior: $PREVIOUS_VERSION"

  update-version-references:
    name: ðŸ”„ Actualizar Referencias de VersiÃ³n
    runs-on: ubuntu-latest
    needs: detect-version-change
    if: needs.detect-version-change.outputs.version-changed == 'true'
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Obtener versiÃ³n dinÃ¡mica
        id: get-version
        run: |
          VERSION="${{ needs.detect-version-change.outputs.current-version }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ VersiÃ³n a usar: $VERSION"
          
      - name: Actualizar referencias en documentaciÃ³n
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          
          echo "ðŸ”„ Actualizando referencias a v$VERSION..."
          
          # Actualizar referencias en archivos de documentaciÃ³n
          find . -name "*.md" -type f ! -path "./.git/*" ! -path "./versions/*" -exec grep -l "v[0-9]\+\.[0-9]\+\.[0-9]\+" {} \; | while read -r file; do
            echo "ðŸ“ Actualizando $file..."
            # Reemplazar versiones hardcodeadas con versiÃ³n actual
            sed -i "s/VersiÃ³n [0-9]\+\.[0-9]\+\.[0-9]\+/VersiÃ³n $VERSION/g" "$file"
            sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$VERSION/g" "$file"
            sed -i "s/ConstituciÃ³n v[0-9]\+\.[0-9]\+\.[0-9]\+/ConstituciÃ³n v$VERSION/g" "$file"
          done
          
          # Actualizar scripts con funciÃ³n de versiÃ³n dinÃ¡mica
          find . -name "*.sh" -type f ! -path "./.git/*" -exec grep -l "v[0-9]\+\.[0-9]\+\.[0-9]\+" {} \; | while read -r script; do
            echo "ðŸ”§ Actualizando script $script..."
            # Agregar funciÃ³n para obtener versiÃ³n dinÃ¡mica si no existe
            if ! grep -q "get_current_version()" "$script"; then
              # Insertar funciÃ³n despuÃ©s del shebang
              sed -i '2i\\n# FunciÃ³n para obtener versiÃ³n actual dinÃ¡micamente\nget_current_version() {\n    if [ -f "CHANGELOG.md" ]; then\n        grep -m 1 "^## \\[" CHANGELOG.md | sed '\''s/## \\[\\([^]]*\\)\\].*/\\1/'\''\n    elif [ -f "../CHANGELOG.md" ]; then\n        grep -m 1 "^## \\[" ../CHANGELOG.md | sed '\''s/## \\[\\([^]]*\\)\\].*/\\1/'\''\n    else\n        echo "'$VERSION'"\n    fi\n}\n' "$script"
            fi
            
            # Reemplazar versiones hardcodeadas con llamada a funciÃ³n
            sed -i 's/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$(get_current_version)/g' "$script"
          done
          
      - name: Actualizar plantillas de GitHub Issues
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          
          echo "ðŸ”„ Actualizando plantillas de GitHub Issues..."
          
          # Actualizar referencias en plantillas YAML
          find .github/ISSUE_TEMPLATE/ -name "*.yml" -exec grep -l "v[0-9]\+\.[0-9]\+\.[0-9]\+" {} \; | while read -r template; do
            echo "ðŸ“‹ Actualizando plantilla $template..."
            sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v$VERSION/g" "$template"
          done
          
      - name: Verificar cambios realizados
        run: |
          echo "ðŸ“Š Resumen de archivos modificados:"
          git diff --name-only
          
          echo "ðŸ“‹ Cambios realizados:"
          git diff --stat
          
      - name: Commit cambios automÃ¡ticos
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "chore: Actualizar referencias de versiÃ³n a v$VERSION

            ðŸ”„ ActualizaciÃ³n automÃ¡tica de referencias hardcodeadas

            ðŸ“ Cambios realizados:
            - Referencias de documentaciÃ³n actualizadas a v$VERSION  
            - Scripts mejorados con funciÃ³n get_current_version()
            - Plantillas de GitHub Issues actualizadas
            - Sistema de versionado dinÃ¡mico implementado

            ðŸ¤– Generado automÃ¡ticamente por GitHub Actions"
            
            git push
            echo "âœ… Cambios commitados y pusheados"
          else
            echo "â„¹ï¸ No hay cambios para commitear"
          fi

  archive-major-version:
    name: ðŸ“š Archivar VersiÃ³n MAJOR
    runs-on: ubuntu-latest
    needs: [detect-version-change, update-version-references]
    if: needs.detect-version-change.outputs.change-type == 'major'
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Archivar versiÃ³n anterior en /versions/
        run: |
          CURRENT_VERSION="${{ needs.detect-version-change.outputs.current-version }}"
          PREVIOUS_VERSION="${{ needs.detect-version-change.outputs.previous-version }}"
          
          echo "ðŸ“š Archivando versiÃ³n MAJOR anterior: v$PREVIOUS_VERSION"
          
          # Crear directorio versions si no existe
          mkdir -p versions
          
          # Crear archivo de versiÃ³n anterior
          ARCHIVE_FILE="versions/v$PREVIOUS_VERSION-CONSTITUTION.md"
          
          # Obtener contenido de la constituciÃ³n del commit anterior
          git checkout HEAD~1 -- CONSTITUTION.md
          cp CONSTITUTION.md "$ARCHIVE_FILE"
          git checkout HEAD -- CONSTITUTION.md
          
          # Agregar header de archivo histÃ³rico
          cat > temp_header.md << EOF
          # ARCHIVO HISTÃ“RICO - ConstituciÃ³n v$PREVIOUS_VERSION
          
          > **âš ï¸ VERSIÃ“N NO VIGENTE**  
          > Esta es una versiÃ³n histÃ³rica de la ConstituciÃ³n de la UniÃ³n Untravel.  
          > **VersiÃ³n vigente actual:** [v$CURRENT_VERSION](../CONSTITUTION.md)  
          > **PerÃ­odo de vigencia:** Hasta el $(date +"%d de %B de %Y")  
          > **Archivada automÃ¡ticamente por:** GitHub Actions
          
          ---
          
          EOF
          
          cat temp_header.md "$ARCHIVE_FILE" > temp_combined.md
          mv temp_combined.md "$ARCHIVE_FILE"
          rm temp_header.md
          
          # Actualizar herramienta de comparaciÃ³n
          if [ ! -f "versions/compare-versions.sh" ]; then
            # Si no existe, crear enlace simbÃ³lico o copia
            ln -sf ../Legislativo/tools/validate-proposal.sh versions/ 2>/dev/null || true
          fi
          
          git add versions/
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git commit -m "archive: Archivar ConstituciÃ³n v$PREVIOUS_VERSION (versiÃ³n MAJOR)

            ðŸ“š Archivo histÃ³rico creado automÃ¡ticamente

            **VersiÃ³n archivada:** v$PREVIOUS_VERSION  
            **Nueva versiÃ³n vigente:** v$CURRENT_VERSION  
            **Tipo de cambio:** MAJOR (cambio estructural profundo)  
            **Archivo:** versions/v$PREVIOUS_VERSION-CONSTITUTION.md

            ðŸ¤– Archivado automÃ¡ticamente por GitHub Actions segÃºn ArtÃ­culo 35"
          
          git push
          echo "âœ… VersiÃ³n v$PREVIOUS_VERSION archivada exitosamente"

  create-release:
    name: ðŸš€ Crear Release
    runs-on: ubuntu-latest
    needs: [detect-version-change, update-version-references]
    if: needs.detect-version-change.outputs.version-changed == 'true' && (github.event.inputs.create_release == 'true' || github.event.inputs.create_release == '')
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: Generar notas del release
        id: release-notes
        run: |
          VERSION="${{ needs.detect-version-change.outputs.current-version }}"
          CHANGE_TYPE="${{ needs.detect-version-change.outputs.change-type }}"
          
          # Obtener cambios del CHANGELOG
          CHANGELOG_SECTION=""
          if [ -f "CHANGELOG.md" ]; then
            # Extraer secciÃ³n de la versiÃ³n actual
            CHANGELOG_SECTION=$(awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          fi
          
          # Mapear tipo de cambio a descripciÃ³n
          case $CHANGE_TYPE in
            "major")
              CHANGE_DESCRIPTION="ðŸ—ï¸ **Cambio Estructural Profundo (MAJOR)**"
              IMPACT="Esta versiÃ³n introduce cambios significativos en la estructura constitucional."
              ;;
            "minor")
              CHANGE_DESCRIPTION="âœ¨ **Nueva Funcionalidad (MINOR)**"
              IMPACT="Esta versiÃ³n agrega nuevas funcionalidades sin romper compatibilidad."
              ;;
            "patch")
              CHANGE_DESCRIPTION="ðŸ”§ **CorrecciÃ³n y Mejoras (PATCH)**"
              IMPACT="Esta versiÃ³n incluye correcciones menores y clarificaciones."
              ;;
          esac
          
          # Generar notas completas
          cat > release_notes.md << EOF
          # ðŸ›ï¸ ConstituciÃ³n de la UniÃ³n Untravel v$VERSION
          
          $CHANGE_DESCRIPTION
          
          ## ðŸ“‹ Resumen
          $IMPACT
          
          ## ðŸ“Š Cambios en esta VersiÃ³n
          
          $CHANGELOG_SECTION
          
          ## ðŸ“š DocumentaciÃ³n
          - [ðŸ“œ ConstituciÃ³n Completa](./CONSTITUTION.md)
          - [ðŸ“– GuÃ­a de ContribuciÃ³n](./CONTRIBUTING.md)
          - [ðŸ”§ Herramientas Legislativas](./Legislativo/)
          - [ðŸ“Š Historial de Cambios](./CHANGELOG.md)
          
          ## ðŸ›ï¸ Proceso Legislativo
          - **Aprobada por:** Alto Congreso Tlatocan
          - **Base legal:** ArtÃ­culos 15, 16 y 35
          - **PromulgaciÃ³n:** Gaceta Oficial de Untravel
          - **Entrada en vigor:** Inmediata
          
          ## ðŸ”— Enlaces Ãštiles
          - [ðŸ›ï¸ Sistema Legislativo](./Legislativo/README.md)
          - [ðŸ“‹ Crear Propuesta](./../../issues/new/choose)
          - [ðŸ’¬ Discusiones](./../../discussions)
          
          ---
          
          ### ðŸ“… InformaciÃ³n del Release
          **Fecha:** $(date +"%d de %B de %Y")  
          **Hora:** $(date +"%H:%M UTC")  
          **Generado por:** GitHub Actions  
          **Hash:** ${GITHUB_SHA:0:7}
          
          *"Transparencia, Democracia y Justicia Digital"* - ArtÃ­culo 4, ConstituciÃ³n de Untravel
          EOF
          
          echo "ðŸ“ Notas del release generadas"
          
      - name: Crear Release en GitHub
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.detect-version-change.outputs.current-version }}
          release_name: ðŸ›ï¸ ConstituciÃ³n v${{ needs.detect-version-change.outputs.current-version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          
      - name: Notificar en Issues relacionados
        uses: actions/github-script@v7
        with:
          script: |
            const version = "${{ needs.detect-version-change.outputs.current-version }}";
            
            // Buscar issues cerrados recientemente que podrÃ­an estar relacionados
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              labels: 'legislativo,reforma-constitucional',
              since: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString() // Ãšltimos 7 dÃ­as
            });
            
            const notification = `## ðŸŽ‰ ConstituciÃ³n v${version} Promulgada
            
            La nueva versiÃ³n de la ConstituciÃ³n ha sido oficialmente promulgada y publicada.
            
            **ðŸš€ Release:** [v${version}](../releases/tag/v${version})  
            **ðŸ“œ ConstituciÃ³n:** [VersiÃ³n actual](../CONSTITUTION.md)  
            **ðŸ“Š Cambios:** [CHANGELOG.md](../CHANGELOG.md)
            
            **Esta propuesta ha sido implementada exitosamente en la nueva versiÃ³n constitucional.**
            
            Â¡Gracias por tu contribuciÃ³n al marco democrÃ¡tico de Untravel! ðŸ›ï¸`;
            
            // Comentar en issues relacionados
            for (const issue of issues.slice(0, 5)) { // MÃ¡ximo 5 para evitar spam
              await github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: notification
              });
            }

  generate-statistics:
    name: ðŸ“Š Generar EstadÃ­sticas
    runs-on: ubuntu-latest
    needs: detect-version-change
    if: needs.detect-version-change.outputs.version-changed == 'true'
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Historia completa para estadÃ­sticas
          
      - name: Generar estadÃ­sticas constitucionales
        run: |
          VERSION="${{ needs.detect-version-change.outputs.current-version }}"
          
          echo "ðŸ“Š Generando estadÃ­sticas para v$VERSION..."
          
          # Crear directorio de estadÃ­sticas
          mkdir -p .github/stats
          
          # Contar artÃ­culos, tÃ­tulos, etc.
          ARTICLES=$(grep -c "^### ArtÃ­culo" CONSTITUTION.md || echo "0")
          TITLES=$(grep -c "^## TÃTULO" CONSTITUTION.md || echo "0")
          WORDS=$(wc -w < CONSTITUTION.md)
          LINES=$(wc -l < CONSTITUTION.md)
          
          # Obtener estadÃ­sticas de commits
          COMMITS_TOTAL=$(git rev-list --count HEAD)
          COMMITS_THIS_YEAR=$(git rev-list --count --since="2025-01-01" HEAD)
          
          # EstadÃ­sticas de contribuidores
          CONTRIBUTORS=$(git log --format='%ae' | sort -u | wc -l)
          
          # Generar archivo de estadÃ­sticas
          cat > .github/stats/v${VERSION}.json << EOF
          {
            "version": "$VERSION",
            "generated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "constitution": {
              "articles": $ARTICLES,
              "titles": $TITLES,
              "words": $WORDS,
              "lines": $LINES
            },
            "repository": {
              "total_commits": $COMMITS_TOTAL,
              "commits_this_year": $COMMITS_THIS_YEAR,
              "contributors": $CONTRIBUTORS
            },
            "legislative_process": {
              "version_type": "${{ needs.detect-version-change.outputs.change-type }}",
              "automation_enabled": true,
              "github_actions": true
            }
          }
          EOF
          
          echo "ðŸ“Š EstadÃ­sticas generadas y guardadas en .github/stats/v${VERSION}.json"
          
          # Commit estadÃ­sticas
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/stats/
          git commit -m "stats: Generar estadÃ­sticas para v$VERSION" || echo "No hay cambios en estadÃ­sticas"
          git push || echo "No hay cambios para pushear"