name: ValidaciÃ³n Constitucional

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validar-markdown:
    name: Validar Sintaxis Markdown
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: Configurar Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Instalar markdownlint
      run: npm install -g markdownlint-cli
      
    - name: Validar archivos Markdown
      run: |
        markdownlint '**/*.md' \
          --ignore node_modules \
          --ignore .git \
          --config .markdownlint.json || true
      continue-on-error: true

  validar-enlaces:
    name: Validar Enlaces
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: Validar enlaces en Markdown
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'no'
        config-file: '.markdown-link-check.json'
        folder-path: '.'
        file-path: './README.md, ./CONSTITUTION.md, ./CHANGELOG.md, ./CONTRIBUTING.md'
      continue-on-error: true

  validar-estructura:
    name: Validar Estructura del Repositorio
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: Verificar archivos requeridos
      run: |
        echo "Verificando estructura del repositorio..."
        
        archivos_requeridos=(
          "README.md"
          "CONSTITUTION.md"
          "CHANGELOG.md"
          "CONTRIBUTING.md"
          "LICENSE"
          ".github/PULL_REQUEST_TEMPLATE.md"
          ".github/ISSUE_TEMPLATE/reforma.md"
          ".github/ISSUE_TEMPLATE/mejora.md"
          ".github/ISSUE_TEMPLATE/error.md"
        )
        
        directorios_requeridos=(
          "reformas"
          "reformas/aprobadas"
          "reformas/en-proceso"
          "reformas/rechazadas"
          "versions"
          ".github"
          ".github/ISSUE_TEMPLATE"
          ".github/workflows"
        )
        
        error=0
        
        for archivo in "${archivos_requeridos[@]}"; do
          if [ ! -f "$archivo" ]; then
            echo "âŒ Error: Falta el archivo requerido: $archivo"
            error=1
          else
            echo "âœ… Archivo encontrado: $archivo"
          fi
        done
        
        for directorio in "${directorios_requeridos[@]}"; do
          if [ ! -d "$directorio" ]; then
            echo "âŒ Error: Falta el directorio requerido: $directorio"
            error=1
          else
            echo "âœ… Directorio encontrado: $directorio"
          fi
        done
        
        if [ $error -eq 1 ]; then
          echo "âš ï¸ Advertencia: Algunos archivos o directorios requeridos no se encontraron"
          exit 0  # No falla el workflow, solo advierte
        else
          echo "âœ… Estructura del repositorio es correcta"
        fi
        
        # Validar archivo de versiones histÃ³ricas
        if [ -f "versions/README.md" ]; then
          echo "âœ… Archivo de versiones histÃ³ricas encontrado"
          
          # Contar versiones archivadas
          versiones_count=$(find versions -name "v*.0.0-CONSTITUTION.md" | wc -l)
          echo "ğŸ“š Versiones histÃ³ricas archivadas: $versiones_count"
          
          # Verificar que cada versiÃ³n tenga marcador de archivo histÃ³rico
          for archivo in versions/v*.0.0-CONSTITUTION.md; do
            if [ -f "$archivo" ]; then
              if grep -q "ARCHIVO HISTÃ“RICO" "$archivo"; then
                echo "âœ… $(basename $archivo): Marcado correctamente como histÃ³rico"
              else
                echo "âš ï¸ $(basename $archivo): Falta marcador de archivo histÃ³rico"
              fi
            fi
          done
        else
          echo "âš ï¸ Advertencia: Archivo versions/README.md no encontrado"
        fi

  validar-version:
    name: Validar Versionado
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Verificar actualizaciÃ³n de versiÃ³n
      run: |
        echo "Verificando si se actualizÃ³ el versionado..."
        
        # Verificar si CONSTITUTION.md fue modificado
        if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -q "CONSTITUTION.md"; then
          echo "ğŸ“ CONSTITUTION.md fue modificado"
          
          # Verificar si CHANGELOG.md tambiÃ©n fue modificado
          if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -q "CHANGELOG.md"; then
            echo "âœ… CHANGELOG.md tambiÃ©n fue actualizado"
            
            # Extraer versiÃ³n del CONSTITUTION.md
            version=$(grep -m 1 "^\*\*VersiÃ³n:\*\*" CONSTITUTION.md | sed 's/.*VersiÃ³n:\*\* //' | sed 's/ .*//')
            echo "ğŸ“Œ VersiÃ³n en CONSTITUTION.md: $version"
            
            # Verificar formato de versiÃ³n semÃ¡ntica
            if [[ $version =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "âœ… Formato de versiÃ³n es vÃ¡lido (SemVer)"
            else
              echo "âš ï¸ Advertencia: El formato de versiÃ³n podrÃ­a no seguir SemVer correctamente"
            fi
          else
            echo "âš ï¸ Advertencia: CONSTITUTION.md fue modificado pero CHANGELOG.md no fue actualizado"
            echo "Considera actualizar CHANGELOG.md para documentar los cambios"
          fi
        else
          echo "â„¹ï¸ CONSTITUTION.md no fue modificado en este PR"
        fi
      continue-on-error: true

  validar-contenido:
    name: Validar Contenido Constitucional
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout cÃ³digo
      uses: actions/checkout@v3
      
    - name: Verificar integridad constitucional
      run: |
        echo "Verificando integridad del contenido..."
        
        # Verificar que existan las secciones principales
        secciones_principales=(
          "TÃTULO I: PRINCIPIOS FUNDAMENTALES"
          "TÃTULO II: DERECHOS Y GARANTÃAS FUNDAMENTALES"
          "TÃTULO III: ORGANIZACIÃ“N DEL PODER PÃšBLICO"
          "TÃTULO VII: REFORMAS Y PROCEDIMIENTOS CONSTITUCIONALES"
        )
        
        error=0
        
        for seccion in "${secciones_principales[@]}"; do
          if grep -q "$seccion" CONSTITUTION.md; then
            echo "âœ… SecciÃ³n encontrada: $seccion"
          else
            echo "âš ï¸ Advertencia: No se encontrÃ³ la secciÃ³n: $seccion"
            error=1
          fi
        done
        
        # Verificar que no se eliminen artÃ­culos irreformables
        articulos_irreformables=(
          "ArtÃ­culo 1:"
          "ArtÃ­culo 2:"
          "ArtÃ­culo 21:"
        )
        
        for articulo in "${articulos_irreformables[@]}"; do
          if grep -q "$articulo" CONSTITUTION.md; then
            echo "âœ… ArtÃ­culo irreformable presente: $articulo"
          else
            echo "âŒ Error: ArtÃ­culo irreformable faltante: $articulo"
            error=1
          fi
        done
        
        # Verificar protecciÃ³n de marca
        if grep -q "Untravel" CONSTITUTION.md && grep -q "marca" CONSTITUTION.md; then
          echo "âœ… ProtecciÃ³n de marca 'Untravel' presente"
        else
          echo "âš ï¸ Advertencia: ProtecciÃ³n de marca 'Untravel' podrÃ­a estar faltante"
        fi
        
        if [ $error -eq 1 ]; then
          echo "âš ï¸ Se encontraron advertencias en la validaciÃ³n de contenido"
          exit 0  # No falla, solo advierte
        else
          echo "âœ… ValidaciÃ³n de contenido completada exitosamente"
        fi

  resumen-validacion:
    name: Resumen de ValidaciÃ³n
    runs-on: ubuntu-latest
    needs: [validar-markdown, validar-enlaces, validar-estructura, validar-version, validar-contenido]
    if: always()
    
    steps:
    - name: Resumen
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“Š RESUMEN DE VALIDACIÃ“N CONSTITUCIONAL"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "âœ… ValidaciÃ³n de sintaxis Markdown: ${{ needs.validar-markdown.result }}"
        echo "âœ… ValidaciÃ³n de enlaces: ${{ needs.validar-enlaces.result }}"
        echo "âœ… ValidaciÃ³n de estructura: ${{ needs.validar-estructura.result }}"
        echo "âœ… ValidaciÃ³n de versionado: ${{ needs.validar-version.result }}"
        echo "âœ… ValidaciÃ³n de contenido: ${{ needs.validar-contenido.result }}"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ›ï¸ Por la justicia, la igualdad y la libertad en Untravel"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
