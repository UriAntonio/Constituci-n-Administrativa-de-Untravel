name: ğŸ›ï¸ ValidaciÃ³n Legislativa AutomÃ¡tica

on:
  issues:
    types: [opened, edited, labeled, unlabeled]
  issue_comment:
    types: [created, edited]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  validate-proposal:
    name: âœ… Validar Propuesta Legislativa
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        
      - name: Obtener versiÃ³n actual
        id: version
        run: |
          if [ -f "CHANGELOG.md" ]; then
            VERSION=$(grep -m 1 "^## \[" CHANGELOG.md | sed 's/## \[\([^]]*\)\].*/\1/')
          else
            VERSION="3.0.0"
          fi
          echo "current=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Detectar tipo de propuesta
        id: detect
        run: |
          TITLE="${{ github.event.issue.title }}"
          
          if [[ "$TITLE" =~ ^\[LEGISLATIVO\] ]]; then
            echo "type=legislativa-interna" >> $GITHUB_OUTPUT
            echo "process=acelerado" >> $GITHUB_OUTPUT
          elif [[ "$TITLE" =~ ^\[RESPALDADA\] ]]; then
            echo "type=propuesta-respaldada" >> $GITHUB_OUTPUT
            echo "process=semi-acelerado" >> $GITHUB_OUTPUT
          elif [[ "$TITLE" =~ ^\[URGENTE\] ]]; then
            echo "type=reforma-urgente" >> $GITHUB_OUTPUT
            echo "process=emergencia" >> $GITHUB_OUTPUT
          else
            echo "type=propuesta-ciudadana" >> $GITHUB_OUTPUT
            echo "process=estÃ¡ndar" >> $GITHUB_OUTPUT
          fi
          
      - name: Validar estructura bÃ¡sica
        id: validate
        run: |
          BODY="${{ github.event.issue.body }}"
          TITLE="${{ github.event.issue.title }}"
          
          SCORE=0
          
          # Validar tÃ­tulo
          if [[ "$TITLE" =~ ^\[(LEGISLATIVO|RESPALDADA|URGENTE)\] ]]; then
            SCORE=$((SCORE + 1))
          fi
          
          # Validar contenido bÃ¡sico
          if echo "$BODY" | grep -qi "propuesta"; then
            SCORE=$((SCORE + 1))
          fi
          
          if echo "$BODY" | grep -qi "justificaciÃ³n"; then
            SCORE=$((SCORE + 1))
          fi
          
          PERCENTAGE=$((SCORE * 100 / 3))
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
          
          if [ $PERCENTAGE -ge 70 ]; then
            echo "status=VÃLIDA" >> $GITHUB_OUTPUT
          else
            echo "status=REQUIERE_MEJORAS" >> $GITHUB_OUTPUT
          fi
          
      - name: ğŸ“ Procesar con nueva herramienta de validaciÃ³n
        id: advanced-validation
        uses: actions/github-script@v7
        with:
          script: |
            // Usar la nueva herramienta de validaciÃ³n completa
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = context.issue.number;
            
            console.log('ğŸ”„ Activando validaciÃ³n avanzada con GitHub Actions...');
            
            // Triggear el workflow de herramientas legislativas
            const { data: dispatch } = await github.rest.actions.createWorkflowDispatch({
              owner: owner,
              repo: repo,
              workflow_id: 'legislative-tools-replacement.yml',
              ref: 'main',
              inputs: {
                action: 'validate-proposal',
                issue_number: issueNumber.toString(),
                additional_params: 'auto-triggered'
              }
            });
            
            console.log('âœ… ValidaciÃ³n avanzada activada');
            
            // Comentario de activaciÃ³n
            const commentBody = `## ğŸ¤– ValidaciÃ³n AutomÃ¡tica Iniciada (GitHub Actions)
            
            **Propuesta:** ${{ steps.issue-info.outputs.title }}
            **Tipo:** ${{ steps.validate-type.outputs.proposal-type }}
            **Sistema:** GitHub Actions v${{ steps.get-version.outputs.version }}
            
            ğŸ”„ **Procesando con herramientas avanzadas...**
            
            âœ… Se ha activado el **sistema de validaciÃ³n completo** que reemplaza los scripts .sh
            
            ğŸ“‹ **El validador automatizado incluirÃ¡:**
            - AnÃ¡lisis estructural completo
            - VerificaciÃ³n constitucional 
            - EstadÃ­sticas detalladas
            - Recomendaciones especÃ­ficas
            - CertificaciÃ³n criptogrÃ¡fica
            
            â±ï¸ **Tiempo estimado:** 2-3 minutos  
            ğŸ“Š **Ver progreso:** [Actions Tab](../../actions)
            
            ---
            ğŸ›ï¸ *Sistema GitHub Actions - Sin dependencias de scripts externos*
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

  track-votes:
    name: ğŸ—³ï¸ Registrar Votos
    runs-on: ubuntu-latest  
    if: github.event_name == 'issue_comment' && contains(github.event.comment.body, 'VOTO OFICIAL')
    steps:
      - name: Procesar voto
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            const author = context.payload.comment.user.login;
            
            let reaction = 'eyes';
            if (comment.includes('APRUEBO') || comment.includes('âœ…')) {
              reaction = '+1';
            } else if (comment.includes('RECHAZO') || comment.includes('âŒ')) {
              reaction = '-1';
            } else if (comment.includes('ABSTENCIÃ“N') || comment.includes('ğŸŸ¡')) {
              reaction = 'confused';
            }
            
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: reaction
            });
            
            console.log(`Voto registrado: ${author} - ${reaction}`);
